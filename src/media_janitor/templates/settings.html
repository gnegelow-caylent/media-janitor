{% extends "base.html" %}

{% block title %}Settings - Media Janitor{% endblock %}

{% block content %}
<div class="flex gap-8">
    <!-- Side Navigation -->
    <nav class="w-56 flex-shrink-0">
        <div class="sticky top-24 space-y-1">
            <button onclick="showSection('general')" class="settings-nav-btn active" data-section="general">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                General
            </button>
            <button onclick="showSection('connections')" class="settings-nav-btn" data-section="connections">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                </svg>
                Connections
            </button>
            <button onclick="showSection('actions')" class="settings-nav-btn" data-section="actions">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Actions
            </button>
            <button onclick="showSection('notifications')" class="settings-nav-btn" data-section="notifications">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                </svg>
                Notifications
            </button>

            <div class="pt-6 mt-6 border-t border-gray-700">
                <button onclick="saveAllSettings()" class="w-full flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-semibold text-gray-900 hover:bg-yellow-500 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 min-w-0">
        <!-- General Section -->
        <div id="section-general" class="settings-section space-y-6">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-white">General</h2>
                <p class="text-sm text-gray-400 mt-1">Basic settings and appearance</p>
            </div>

            <div class="settings-card">
                <div class="settings-row">
                    <div>
                        <h4 class="settings-label">Theme</h4>
                        <p class="settings-hint">Choose your preferred appearance</p>
                    </div>
                    <div class="flex gap-3">
                        <label class="theme-option">
                            <input type="radio" name="theme" value="dark" id="theme-dark" class="sr-only peer">
                            <div class="theme-box bg-gray-900 peer-checked:ring-2 peer-checked:ring-primary">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">Dark</span>
                        </label>
                        <label class="theme-option">
                            <input type="radio" name="theme" value="light" id="theme-light" class="sr-only peer">
                            <div class="theme-box bg-gray-200 peer-checked:ring-2 peer-checked:ring-primary">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">Light</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-row">
                    <div>
                        <h4 class="settings-label">Timezone</h4>
                        <p class="settings-hint">Used for scheduling and log timestamps</p>
                    </div>
                    <select id="timezone" class="form-select w-64">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Central European (CET)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Australia/Sydney">Sydney (AEST)</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Connections Section -->
        <div id="section-connections" class="settings-section hidden space-y-6">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-white">Connections</h2>
                <p class="text-sm text-gray-400 mt-1">Connect to your media servers</p>
            </div>

            <!-- Radarr -->
            <div class="settings-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-orange-500/20 flex items-center justify-center">
                            <svg class="w-6 h-6 text-orange-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">Radarr</h3>
                            <p class="text-sm text-gray-400">Movie management</p>
                        </div>
                    </div>
                    <button onclick="addInstance('radarr')" class="text-sm text-orange-400 hover:text-orange-300">+ Add</button>
                </div>
                <div id="radarr-instances" class="space-y-3"></div>
            </div>

            <!-- Sonarr -->
            <div class="settings-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM9 8h2v8H9zm4 0h2v8h-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">Sonarr</h3>
                            <p class="text-sm text-gray-400">TV show management</p>
                        </div>
                    </div>
                    <button onclick="addInstance('sonarr')" class="text-sm text-blue-400 hover:text-blue-300">+ Add</button>
                </div>
                <div id="sonarr-instances" class="space-y-3"></div>
            </div>

            <!-- Plex -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                            <svg class="w-6 h-6 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm4.5 17.5h-9l4.5-11 4.5 11z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">Plex</h3>
                            <p class="text-sm text-gray-400">Library refresh triggers</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="plex-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-400">Server URL</label>
                        <input type="text" id="plex-url" class="form-input mt-1" placeholder="http://192.168.1.3:32400">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Token</label>
                        <input type="password" id="plex-token" class="form-input mt-1" placeholder="Plex token">
                    </div>
                </div>
                <div class="mt-3 flex items-center gap-3">
                    <button onclick="testPlex()" class="text-sm text-yellow-400 hover:text-yellow-300">Test Connection</button>
                    <span id="plex-status" class="text-sm"></span>
                </div>
            </div>
        </div>

        <!-- Actions Section -->
        <div id="section-actions" class="settings-section hidden space-y-6">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-white">Actions</h2>
                <p class="text-sm text-gray-400 mt-1">Configure automatic behaviors</p>
            </div>

            <div class="settings-card">
                <div class="settings-row border-b border-gray-700 pb-4 mb-4">
                    <div>
                        <h4 class="settings-label text-blue-400">Dry Run Mode</h4>
                        <p class="settings-hint">Report issues but don't make changes (safe testing)</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="actions-dry-run">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div>
                        <h4 class="settings-label">Auto Replace Bad Files</h4>
                        <p class="settings-hint">Delete and re-download files that fail validation</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="actions-auto-replace">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div>
                        <h4 class="settings-label">Auto Delete Duplicates</h4>
                        <p class="settings-hint">Remove lower quality duplicate files</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="actions-auto-delete-duplicates">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div>
                        <h4 class="settings-label">Blocklist Bad Releases</h4>
                        <p class="settings-hint">Add failed releases to blocklist</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="actions-blocklist">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-row">
                    <div>
                        <h4 class="settings-label">Max Replacements Per Day</h4>
                        <p class="settings-hint">Limit daily automatic replacements</p>
                    </div>
                    <input type="number" id="actions-max-replacements" class="form-input w-24 text-center" min="1" max="100">
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div id="section-notifications" class="settings-section hidden space-y-6">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-white">Notifications</h2>
                <p class="text-sm text-gray-400 mt-1">Configure how you receive alerts</p>
            </div>

            <!-- Email -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-medium text-white">Email</h3>
                            <p class="text-sm text-gray-400">Daily summaries and alerts</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="email-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-4 space-y-3">
                    <div class="flex gap-2">
                        <button onclick="setupGmail()" class="text-xs px-3 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Gmail</button>
                        <button onclick="setupOutlook()" class="text-xs px-3 py-1 rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Outlook</button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="email-smtp-host" class="form-input text-sm" placeholder="SMTP Server">
                        <input type="number" id="email-smtp-port" class="form-input text-sm" placeholder="Port">
                        <input type="text" id="email-smtp-user" class="form-input text-sm" placeholder="Username">
                        <input type="password" id="email-smtp-password" class="form-input text-sm" placeholder="Password">
                        <input type="email" id="email-from" class="form-input text-sm" placeholder="From address">
                        <input type="email" id="email-to" class="form-input text-sm" placeholder="To address">
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="testEmail()" class="text-sm text-green-400 hover:text-green-300">Send Test</button>
                        <span id="email-test-result" class="text-sm"></span>
                    </div>
                </div>
            </div>

            <!-- Discord -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-indigo-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                            </svg>
                        </div>
                        <h3 class="font-medium text-white">Discord</h3>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="discord-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-3">
                    <input type="text" id="discord-webhook" class="form-input text-sm" placeholder="Webhook URL">
                    <div class="mt-2 flex items-center gap-3">
                        <button onclick="testNotification('discord')" class="text-sm text-indigo-400 hover:text-indigo-300">Test</button>
                        <span id="discord-test-result" class="text-sm"></span>
                    </div>
                </div>
            </div>

            <!-- Slack -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/>
                            </svg>
                        </div>
                        <h3 class="font-medium text-white">Slack</h3>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="slack-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-3">
                    <input type="text" id="slack-webhook" class="form-input text-sm" placeholder="Webhook URL">
                    <div class="mt-2 flex items-center gap-3">
                        <button onclick="testNotification('slack')" class="text-sm text-green-400 hover:text-green-300">Test</button>
                        <span id="slack-test-result" class="text-sm"></span>
                    </div>
                </div>
            </div>

            <!-- Telegram -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-sky-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </div>
                        <h3 class="font-medium text-white">Telegram</h3>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="telegram-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    <input type="password" id="telegram-bot-token" class="form-input text-sm" placeholder="Bot Token">
                    <input type="text" id="telegram-chat-id" class="form-input text-sm" placeholder="Chat ID">
                </div>
                <div class="mt-2 flex items-center gap-3">
                    <button onclick="testNotification('telegram')" class="text-sm text-sky-400 hover:text-sky-300">Test</button>
                    <span id="telegram-test-result" class="text-sm"></span>
                </div>
            </div>

            <!-- Pushover -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="font-medium text-white">Pushover</h3>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pushover-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    <input type="password" id="pushover-user-key" class="form-input text-sm" placeholder="User Key">
                    <input type="password" id="pushover-api-token" class="form-input text-sm" placeholder="API Token">
                </div>
                <div class="mt-2 flex items-center gap-3">
                    <button onclick="testNotification('pushover')" class="text-sm text-purple-400 hover:text-purple-300">Test</button>
                    <span id="pushover-test-result" class="text-sm"></span>
                </div>
            </div>

            <!-- Gotify -->
            <div class="settings-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-teal-500/20 flex items-center justify-center">
                            <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                        </div>
                        <h3 class="font-medium text-white">Gotify</h3>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="gotify-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    <input type="text" id="gotify-server-url" class="form-input text-sm" placeholder="Server URL">
                    <input type="password" id="gotify-app-token" class="form-input text-sm" placeholder="App Token">
                </div>
                <div class="mt-2 flex items-center gap-3">
                    <button onclick="testNotification('gotify')" class="text-sm text-teal-400 hover:text-teal-300">Test</button>
                    <span id="gotify-test-result" class="text-sm"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 hidden z-50">
    <div class="flex items-center px-5 py-3 rounded-lg shadow-lg text-sm">
        <span id="toast-icon" class="mr-2"></span>
        <span id="toast-message"></span>
    </div>
</div>

<style>
    .settings-nav-btn {
        @apply w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800 transition-colors;
    }
    .settings-nav-btn.active {
        @apply bg-gray-800 text-white;
    }
    .settings-card {
        @apply bg-gray-800/50 rounded-xl p-5 border border-gray-700/50;
    }
    .settings-row {
        @apply flex items-center justify-between py-3;
    }
    .settings-row + .settings-row {
        @apply border-t border-gray-700/50;
    }
    .settings-label {
        @apply text-sm font-medium text-white;
    }
    .settings-hint {
        @apply text-xs text-gray-500 mt-0.5;
    }
    .form-input {
        @apply block w-full rounded-lg bg-gray-700/50 border border-gray-600 text-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary transition-colors;
    }
    .form-select {
        @apply block rounded-lg bg-gray-700/50 border border-gray-600 text-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary;
    }
    .toggle-switch { @apply relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer; }
    .toggle-switch input { @apply sr-only; }
    .toggle-slider { @apply pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-600 transition-colors duration-200; }
    .toggle-slider::before { content: ''; @apply absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white shadow transition-transform duration-200; }
    .toggle-switch input:checked + .toggle-slider { @apply bg-primary; }
    .toggle-switch input:checked + .toggle-slider::before { @apply translate-x-5; }
    .theme-option { @apply flex flex-col items-center cursor-pointer; }
    .theme-box { @apply w-16 h-12 rounded-lg flex items-center justify-center transition-all; }
    .instance-row { @apply flex items-center gap-3 p-3 bg-gray-700/30 rounded-lg; }
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentConfig = {};

    function showSection(name) {
        document.querySelectorAll('.settings-section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.settings-nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`section-${name}`).classList.remove('hidden');
        document.querySelector(`[data-section="${name}"]`).classList.add('active');
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        toast.firstElementChild.className = `flex items-center px-5 py-3 rounded-lg shadow-lg text-sm ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
        document.getElementById('toast-message').textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            currentConfig = await response.json();
            populateForm();
        } catch (e) {
            showToast('Failed to load config', true);
        }
    }

    function populateForm() {
        // General
        document.getElementById(`theme-${currentConfig.ui?.theme || 'dark'}`).checked = true;
        document.getElementById('timezone').value = currentConfig.ui?.timezone || 'America/New_York';

        // Plex
        document.getElementById('plex-enabled').checked = currentConfig.plex?.enabled ?? false;
        document.getElementById('plex-url').value = currentConfig.plex?.url ?? '';
        document.getElementById('plex-token').value = currentConfig.plex?.token ?? '';

        // Actions
        document.getElementById('actions-dry-run').checked = currentConfig.actions?.dry_run ?? false;
        document.getElementById('actions-auto-replace').checked = currentConfig.actions?.auto_replace ?? true;
        document.getElementById('actions-auto-delete-duplicates').checked = currentConfig.actions?.auto_delete_duplicates ?? false;
        document.getElementById('actions-blocklist').checked = currentConfig.actions?.blocklist_bad_releases ?? true;
        document.getElementById('actions-max-replacements').value = currentConfig.actions?.max_replacements_per_day ?? 10;

        // Email
        document.getElementById('email-enabled').checked = currentConfig.email?.enabled ?? false;
        document.getElementById('email-smtp-host').value = currentConfig.email?.smtp_host ?? '';
        document.getElementById('email-smtp-port').value = currentConfig.email?.smtp_port ?? 587;
        document.getElementById('email-smtp-user').value = currentConfig.email?.smtp_user ?? '';
        document.getElementById('email-from').value = currentConfig.email?.from_address ?? '';
        document.getElementById('email-to').value = currentConfig.email?.to_address ?? '';

        // Notifications
        const notif = currentConfig.notifications || {};
        document.getElementById('discord-enabled').checked = notif.discord?.enabled ?? false;
        document.getElementById('discord-webhook').value = notif.discord?.webhook_url ?? '';
        document.getElementById('slack-enabled').checked = notif.slack?.enabled ?? false;
        document.getElementById('slack-webhook').value = notif.slack?.webhook_url ?? '';
        document.getElementById('telegram-enabled').checked = notif.telegram?.enabled ?? false;
        document.getElementById('telegram-bot-token').value = notif.telegram?.bot_token ?? '';
        document.getElementById('telegram-chat-id').value = notif.telegram?.chat_id ?? '';
        document.getElementById('pushover-enabled').checked = notif.pushover?.enabled ?? false;
        document.getElementById('pushover-user-key').value = notif.pushover?.user_key ?? '';
        document.getElementById('pushover-api-token').value = notif.pushover?.api_token ?? '';
        document.getElementById('gotify-enabled').checked = notif.gotify?.enabled ?? false;
        document.getElementById('gotify-server-url').value = notif.gotify?.server_url ?? '';
        document.getElementById('gotify-app-token').value = notif.gotify?.app_token ?? '';

        // Instances
        renderInstances('radarr', currentConfig.radarr || []);
        renderInstances('sonarr', currentConfig.sonarr || []);
    }

    function renderInstances(type, instances) {
        const container = document.getElementById(`${type}-instances`);
        if (instances.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 italic">No instances configured</p>';
            return;
        }
        container.innerHTML = instances.map((inst, idx) => `
            <div class="instance-row" data-instance="${type}-${idx}">
                <div class="flex-1 grid grid-cols-3 gap-3">
                    <input type="text" value="${inst.name}" class="form-input text-sm" placeholder="Name" data-field="name">
                    <input type="text" value="${inst.url}" class="form-input text-sm" placeholder="URL" data-field="url">
                    <input type="password" value="${inst.api_key}" class="form-input text-sm" placeholder="API Key" data-field="api_key">
                </div>
                <button onclick="testConnection('${type}', ${idx})" class="text-xs text-gray-400 hover:text-white px-2">Test</button>
                <button onclick="toggleAdvanced('${type}', ${idx})" class="text-xs text-gray-400 hover:text-white px-2">Advanced</button>
                <button onclick="removeInstance('${type}', ${idx})" class="text-xs text-red-400 hover:text-red-300 px-2">Remove</button>
            </div>
            <div id="advanced-${type}-${idx}" class="hidden ml-4 mt-2 p-3 bg-gray-800/50 rounded-lg text-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gray-400">Path Mappings</span>
                    <button onclick="addPathMapping('${type}', ${idx})" class="text-xs text-gray-400 hover:text-white">+ Add</button>
                </div>
                <div class="path-mappings space-y-2">
                    ${(inst.path_mappings || []).map((pm, pmIdx) => `
                        <div class="flex items-center gap-2">
                            <input type="text" value="${pm.from_path}" class="form-input flex-1 text-xs py-1.5" placeholder="Container path" data-field="from_path" data-pm-idx="${pmIdx}">
                            <span class="text-gray-500">→</span>
                            <input type="text" value="${pm.to_path}" class="form-input flex-1 text-xs py-1.5" placeholder="Host path" data-field="to_path" data-pm-idx="${pmIdx}">
                            <button onclick="removePathMapping('${type}', ${idx}, ${pmIdx})" class="text-red-400 hover:text-red-300">×</button>
                        </div>
                    `).join('')}
                </div>
                <p class="text-xs text-gray-500 mt-2">Only needed if container paths differ from host paths</p>
            </div>
        `).join('');
    }

    function toggleAdvanced(type, idx) {
        const el = document.getElementById(`advanced-${type}-${idx}`);
        el.classList.toggle('hidden');
    }

    function addInstance(type) {
        if (!currentConfig[type]) currentConfig[type] = [];
        currentConfig[type].push({ name: `${type}-${currentConfig[type].length + 1}`, url: '', api_key: '', path_mappings: [] });
        renderInstances(type, currentConfig[type]);
    }

    function removeInstance(type, idx) {
        currentConfig[type].splice(idx, 1);
        renderInstances(type, currentConfig[type]);
    }

    function addPathMapping(type, instIdx) {
        if (!currentConfig[type][instIdx].path_mappings) currentConfig[type][instIdx].path_mappings = [];
        currentConfig[type][instIdx].path_mappings.push({ from_path: '', to_path: '' });
        renderInstances(type, currentConfig[type]);
        document.getElementById(`advanced-${type}-${instIdx}`).classList.remove('hidden');
    }

    function removePathMapping(type, instIdx, pmIdx) {
        currentConfig[type][instIdx].path_mappings.splice(pmIdx, 1);
        renderInstances(type, currentConfig[type]);
        document.getElementById(`advanced-${type}-${instIdx}`).classList.remove('hidden');
    }

    async function testConnection(type, idx) {
        const container = document.querySelector(`[data-instance="${type}-${idx}"]`);
        const url = container.querySelector('[data-field="url"]').value;
        const api_key = container.querySelector('[data-field="api_key"]').value;
        try {
            const response = await fetch('/api/test-connection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, url, api_key })
            });
            const data = await response.json();
            showToast(data.success ? `Connected (v${data.version})` : data.error, !data.success);
        } catch (e) {
            showToast('Connection failed', true);
        }
    }

    async function testPlex() {
        const status = document.getElementById('plex-status');
        status.innerHTML = '<span class="text-gray-400">Testing...</span>';
        try {
            const response = await fetch('/api/test-plex', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: document.getElementById('plex-url').value,
                    token: document.getElementById('plex-token').value
                })
            });
            const data = await response.json();
            status.innerHTML = data.success ? '<span class="text-green-400">Connected</span>' : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            status.innerHTML = '<span class="text-red-400">Failed</span>';
        }
    }

    async function testNotification(service) {
        const result = document.getElementById(`${service}-test-result`);
        result.innerHTML = '<span class="text-gray-400">Sending...</span>';
        const payload = { service };
        if (service === 'discord') payload.webhook_url = document.getElementById('discord-webhook').value;
        else if (service === 'slack') payload.webhook_url = document.getElementById('slack-webhook').value;
        else if (service === 'telegram') {
            payload.bot_token = document.getElementById('telegram-bot-token').value;
            payload.chat_id = document.getElementById('telegram-chat-id').value;
        } else if (service === 'pushover') {
            payload.user_key = document.getElementById('pushover-user-key').value;
            payload.api_token = document.getElementById('pushover-api-token').value;
        } else if (service === 'gotify') {
            payload.server_url = document.getElementById('gotify-server-url').value;
            payload.app_token = document.getElementById('gotify-app-token').value;
        }
        try {
            const response = await fetch('/api/test-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            result.innerHTML = data.success ? '<span class="text-green-400">Sent!</span>' : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            result.innerHTML = '<span class="text-red-400">Failed</span>';
        }
    }

    async function testEmail() {
        const result = document.getElementById('email-test-result');
        result.innerHTML = '<span class="text-gray-400">Sending...</span>';
        try {
            const response = await fetch('/api/test-email', { method: 'POST' });
            const data = await response.json();
            result.innerHTML = data.success ? '<span class="text-green-400">Sent!</span>' : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            result.innerHTML = '<span class="text-red-400">Failed</span>';
        }
    }

    function setupGmail() {
        document.getElementById('email-smtp-host').value = 'smtp.gmail.com';
        document.getElementById('email-smtp-port').value = '587';
    }

    function setupOutlook() {
        document.getElementById('email-smtp-host').value = 'smtp.office365.com';
        document.getElementById('email-smtp-port').value = '587';
    }

    function collectFormData() {
        ['radarr', 'sonarr'].forEach(type => {
            const containers = document.querySelectorAll(`[data-instance^="${type}-"]`);
            currentConfig[type] = [];
            containers.forEach((container, idx) => {
                const inst = {
                    name: container.querySelector('[data-field="name"]').value,
                    url: container.querySelector('[data-field="url"]').value,
                    api_key: container.querySelector('[data-field="api_key"]').value,
                    path_mappings: []
                };
                const advDiv = document.getElementById(`advanced-${type}-${idx}`);
                if (advDiv) {
                    advDiv.querySelectorAll('.path-mappings > div').forEach(pmDiv => {
                        const fromPath = pmDiv.querySelector('[data-field="from_path"]');
                        const toPath = pmDiv.querySelector('[data-field="to_path"]');
                        if (fromPath && toPath && (fromPath.value || toPath.value)) {
                            inst.path_mappings.push({ from_path: fromPath.value, to_path: toPath.value });
                        }
                    });
                }
                currentConfig[type].push(inst);
            });
        });

        currentConfig.ui = {
            theme: document.querySelector('input[name="theme"]:checked')?.value || 'dark',
            timezone: document.getElementById('timezone').value
        };

        currentConfig.plex = {
            enabled: document.getElementById('plex-enabled').checked,
            url: document.getElementById('plex-url').value,
            token: document.getElementById('plex-token').value,
            refresh_on_replace: true
        };

        currentConfig.actions = {
            ...currentConfig.actions,
            dry_run: document.getElementById('actions-dry-run').checked,
            auto_replace: document.getElementById('actions-auto-replace').checked,
            auto_delete_duplicates: document.getElementById('actions-auto-delete-duplicates').checked,
            blocklist_bad_releases: document.getElementById('actions-blocklist').checked,
            max_replacements_per_day: parseInt(document.getElementById('actions-max-replacements').value)
        };

        currentConfig.email = {
            ...currentConfig.email,
            enabled: document.getElementById('email-enabled').checked,
            smtp_host: document.getElementById('email-smtp-host').value,
            smtp_port: parseInt(document.getElementById('email-smtp-port').value) || 587,
            smtp_user: document.getElementById('email-smtp-user').value,
            smtp_password: document.getElementById('email-smtp-password').value || currentConfig.email?.smtp_password,
            from_address: document.getElementById('email-from').value,
            to_address: document.getElementById('email-to').value
        };

        currentConfig.notifications = {
            discord: { enabled: document.getElementById('discord-enabled').checked, webhook_url: document.getElementById('discord-webhook').value },
            slack: { enabled: document.getElementById('slack-enabled').checked, webhook_url: document.getElementById('slack-webhook').value },
            telegram: { enabled: document.getElementById('telegram-enabled').checked, bot_token: document.getElementById('telegram-bot-token').value, chat_id: document.getElementById('telegram-chat-id').value },
            pushover: { enabled: document.getElementById('pushover-enabled').checked, user_key: document.getElementById('pushover-user-key').value, api_token: document.getElementById('pushover-api-token').value },
            gotify: { enabled: document.getElementById('gotify-enabled').checked, server_url: document.getElementById('gotify-server-url').value, app_token: document.getElementById('gotify-app-token').value }
        };

        return currentConfig;
    }

    async function saveAllSettings() {
        try {
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(collectFormData())
            });
            showToast(response.ok ? 'Settings saved!' : 'Failed to save', !response.ok);
        } catch (e) {
            showToast('Failed to save', true);
        }
    }

    loadConfig();
</script>
{% endblock %}
