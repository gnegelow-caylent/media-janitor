{% extends "base.html" %}

{% block title %}Settings - Media Janitor{% endblock %}

{% block content %}
<div class="flex min-h-[calc(100vh-12rem)] gap-8">
    <!-- Sidebar Navigation -->
    <aside class="w-56 flex-shrink-0">
        <div class="sticky top-24 bg-white/50 dark:bg-gray-800/50 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
            <!-- Nav Items -->
            <nav class="p-2">
                <button onclick="showSection('general')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-900 dark:text-white bg-gray-200 dark:bg-gray-700 transition-all" data-section="general">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>General</span>
                </button>
                <button onclick="showSection('connections')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all" data-section="connections">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                    </svg>
                    <span>Connections</span>
                </button>
                <button onclick="showSection('actions')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all" data-section="actions">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span>Actions</span>
                </button>
                <button onclick="showSection('notifications')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all" data-section="notifications">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Notifications</span>
                </button>
            </nav>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1">
        <!-- General Section -->
        <section id="section-general" class="settings-section">
            <header class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">General</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Basic application settings</p>
            </header>

            <div class="space-y-6 max-w-2xl">
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <h3 class="px-5 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-100/50 dark:bg-gray-800/50 border-b border-gray-200/50 dark:border-gray-700/50">Appearance</h3>
                    <div class="p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Theme</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Choose your preferred color scheme</p>
                            </div>
                            <div class="flex gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="theme" value="dark" id="theme-dark" class="sr-only peer">
                                    <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-sm transition-all peer-checked:ring-2 peer-checked:ring-primary peer-checked:border-primary">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                                        </svg>
                                        <span>Dark</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="theme" value="light" id="theme-light" class="sr-only peer">
                                    <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-sm transition-all peer-checked:ring-2 peer-checked:ring-primary peer-checked:border-primary">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                                        </svg>
                                        <span>Light</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <h3 class="px-5 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-100/50 dark:bg-gray-800/50 border-b border-gray-200/50 dark:border-gray-700/50">Localization</h3>
                    <div class="p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Timezone</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Used for scheduling and log timestamps</p>
                            </div>
                            <select id="timezone" class="px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all cursor-pointer">
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="Europe/London">London (GMT/BST)</option>
                                <option value="Europe/Paris">Central European (CET)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                <option value="Australia/Sydney">Sydney (AEST)</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="saveAllSettings()" class="save-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-gray-900 text-sm font-semibold cursor-pointer transition-colors hover:bg-yellow-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </section>

        <!-- Connections Section -->
        <section id="section-connections" class="settings-section hidden">
            <header class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Connections</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Connect to your media servers</p>
            </header>

            <div class="space-y-8 max-w-3xl">
                <!-- Radarr -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Radarr</h3>
                                <p class="text-xs text-gray-500">Movie management</p>
                            </div>
                        </div>
                        <button onclick="addInstance('radarr')" class="text-sm text-primary hover:text-yellow-400 font-medium">+ Add Instance</button>
                    </div>
                    <div id="radarr-instances" class="space-y-3"></div>
                    <div class="mt-4 pt-4 border-t border-gray-200/50 dark:border-gray-700/50 flex justify-end">
                        <button onclick="saveAllSettings()" class="save-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-gray-900 text-sm font-semibold cursor-pointer transition-colors hover:bg-yellow-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Save Radarr
                        </button>
                    </div>
                </div>

                <!-- Sonarr -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Sonarr</h3>
                                <p class="text-xs text-gray-500">TV show management</p>
                            </div>
                        </div>
                        <button onclick="addInstance('sonarr')" class="text-sm text-primary hover:text-yellow-400 font-medium">+ Add Instance</button>
                    </div>
                    <div id="sonarr-instances" class="space-y-3"></div>
                    <div class="mt-4 pt-4 border-t border-gray-200/50 dark:border-gray-700/50 flex justify-end">
                        <button onclick="saveAllSettings()" class="save-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-gray-900 text-sm font-semibold cursor-pointer transition-colors hover:bg-yellow-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Save Sonarr
                        </button>
                    </div>
                </div>

                <!-- Plex -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-yellow-500 to-orange-500 flex items-center justify-center shadow-lg">
                            <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm4.5 17.5h-9l4.5-11 4.5 11z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900 dark:text-white">Plex</h3>
                            <p class="text-xs text-gray-500">Library refresh after replacements</p>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="plex-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Server URL</label>
                                <input type="text" id="plex-url" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="http://your-server:32400">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Token</label>
                                <input type="password" id="plex-token" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Your Plex token">
                            </div>
                        </div>
                        <div class="mt-4 flex items-center gap-4">
                            <button onclick="testPlex()" class="text-sm text-primary hover:text-yellow-400 font-medium">Test Connection</button>
                            <span id="plex-status" class="text-sm"></span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200/50 dark:border-gray-700/50 flex justify-end">
                        <button onclick="saveAllSettings()" class="save-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-gray-900 text-sm font-semibold cursor-pointer transition-colors hover:bg-yellow-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Save Plex
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Actions Section -->
        <section id="section-actions" class="settings-section hidden">
            <header class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Actions</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Configure automatic behaviors</p>
            </header>

            <div class="space-y-6 max-w-2xl">
                <!-- Dry Run Mode - Highlighted -->
                <div class="bg-blue-500/5 dark:bg-blue-500/10 rounded-2xl border border-blue-500/30 overflow-hidden">
                    <div class="p-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-blue-400">Dry Run Mode</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Report issues without making any changes (safe testing)</p>
                                </div>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="actions-dry-run">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <h3 class="px-5 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-100/50 dark:bg-gray-800/50 border-b border-gray-200/50 dark:border-gray-700/50">Replacement Behavior</h3>
                    <div class="p-5 space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Auto Replace Bad Files</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Delete and re-download files that fail validation</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="actions-auto-replace">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Blocklist Bad Releases</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Prevent re-downloading the same bad release</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="actions-blocklist">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Max Replacements Per Day</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Limit bandwidth usage with daily caps</p>
                            </div>
                            <input type="number" id="actions-max-replacements" class="settings-input w-20 text-center" min="1" max="100">
                        </div>
                    </div>
                </div>

                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <h3 class="px-5 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-100/50 dark:bg-gray-800/50 border-b border-gray-200/50 dark:border-gray-700/50">Duplicate Handling</h3>
                    <div class="p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Auto Delete Duplicates</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Automatically remove lower quality duplicate copies</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="actions-auto-delete-duplicates">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <h3 class="px-5 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-100/50 dark:bg-gray-800/50 border-b border-gray-200/50 dark:border-gray-700/50">Scanner Settings</h3>
                    <div class="p-5 space-y-4">
                        <!-- Recommendations hint -->
                        <div class="p-3 rounded-lg bg-gray-100/50 dark:bg-gray-900/50 border border-gray-200/50 dark:border-gray-700/50 mb-2">
                            <p class="text-xs text-gray-600 dark:text-gray-400 mb-2"><span class="text-primary font-medium">Recommendations:</span> Match files/hr with parallel scans for optimal throughput. Disable Deep Scan if CPU is limited.</p>
                            <p class="text-xs text-gray-500"><span class="text-gray-600 dark:text-gray-400">HDD:</span> 120/2 or 300/5 &nbsp;|&nbsp; <span class="text-gray-600 dark:text-gray-400">SSD:</span> 600/10 or 1200/20</p>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Scanner Enabled</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Enable background library scanning</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="scanner-enabled">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Files Per Hour</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Network: 500-1500, Local SSD: 3000-5000, NVMe: 5000+</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <input type="range" id="scanner-files-per-hour-slider" min="100" max="10000" step="100" class="w-32" oninput="document.getElementById('scanner-files-per-hour').value = this.value">
                                <input type="number" id="scanner-files-per-hour" class="settings-input w-24 text-center" min="100" max="10000" oninput="document.getElementById('scanner-files-per-hour-slider').value = this.value">
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Scan Mode</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Watch Only = scan library once, then only new imports</p>
                            </div>
                            <select id="scanner-mode" class="px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all cursor-pointer">
                                <option value="watch_only">Watch Only</option>
                                <option value="continuous">Continuous</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Parallel Scans</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Simultaneous validations. HDD: 2-4, SSD: 6-10. Higher = more disk I/O</p>
                            </div>
                            <input type="number" id="scanner-concurrency" class="settings-input w-20 text-center" min="1" max="50">
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Deep Scan</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Decode video samples with ffmpeg. <span class="text-yellow-500">CPU intensive</span> but catches more issues</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="validation-deep-scan">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Deep Scan Mode</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5"><span class="text-green-400">Partial</span> = start only (3x faster) | <span class="text-yellow-400">Full</span> = start/middle/end</p>
                            </div>
                            <select id="validation-deep-scan-mode" class="px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all cursor-pointer">
                                <option value="partial">Partial (Recommended for network mounts)</option>
                                <option value="full">Full (Local storage only)</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Sample Duration</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Seconds to decode per sample. <span class="text-gray-400">Local: 30</span> | <span class="text-blue-400">Network: 5-10</span> (less data to transfer)</p>
                            </div>
                            <input type="number" id="validation-sample-duration" class="settings-input w-20 text-center" min="1" max="60">
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Decode Timeout</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Max seconds per decode test. <span class="text-gray-400">Local: 30-60</span> | <span class="text-blue-400">Network: 60-120</span> (slower I/O)</p>
                            </div>
                            <input type="number" id="validation-decode-timeout" class="settings-input w-20 text-center" min="5" max="300">
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Check Bitrate</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Flag suspiciously low bitrate files. Minimal overhead</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="validation-check-bitrate">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-900 dark:text-white">Replace 3D Movies</label>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-0.5">Detect and replace 3D movies with 2D versions. Checks filename, metadata, and aspect ratio</p>
                            </div>
                            <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                                <input type="checkbox" id="validation-replace-3d">
                                <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="saveAllSettings()" class="save-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-gray-900 text-sm font-semibold cursor-pointer transition-colors hover:bg-yellow-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </section>

        <!-- Notifications Section -->
        <section id="section-notifications" class="settings-section hidden">
            <header class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Notifications</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Configure how you receive alerts</p>
            </header>

            <div class="space-y-6 max-w-2xl">
                <!-- Email -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-500 to-pink-500 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Email</h3>
                                <p class="text-xs text-gray-500">Daily summaries and alerts</p>
                            </div>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="email-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <div class="flex gap-2 mb-4">
                            <button onclick="setupGmail()" class="px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-all">Gmail</button>
                            <button onclick="setupOutlook()" class="px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white transition-all">Outlook</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="email-smtp-host" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="SMTP Server">
                            <input type="number" id="email-smtp-port" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Port">
                            <input type="text" id="email-smtp-user" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Username">
                            <input type="password" id="email-smtp-password" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Password">
                            <input type="email" id="email-from" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="From address">
                            <input type="email" id="email-to" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="To address">
                        </div>
                        <div class="mt-4 flex items-center gap-4">
                            <button onclick="testEmail()" class="text-sm text-primary hover:text-yellow-400 font-medium">Send Test Email</button>
                            <span id="email-test-result" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- Discord -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Discord</h3>
                                <p class="text-xs text-gray-500">Webhook notifications</p>
                            </div>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="discord-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <input type="text" id="discord-webhook" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="https://discord.com/api/webhooks/...">
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="testNotification('discord')" class="text-sm text-primary hover:text-yellow-400 font-medium">Send Test</button>
                            <span id="discord-test-result" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- Slack -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Slack</h3>
                                <p class="text-xs text-gray-500">Webhook notifications</p>
                            </div>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="slack-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <input type="text" id="slack-webhook" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="https://hooks.slack.com/services/...">
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="testNotification('slack')" class="text-sm text-primary hover:text-yellow-400 font-medium">Send Test</button>
                            <span id="slack-test-result" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- Telegram -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-sky-400 to-blue-500 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Telegram</h3>
                                <p class="text-xs text-gray-500">Bot notifications</p>
                            </div>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="telegram-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="password" id="telegram-bot-token" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Bot Token">
                            <input type="text" id="telegram-chat-id" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Chat ID">
                        </div>
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="testNotification('telegram')" class="text-sm text-primary hover:text-yellow-400 font-medium">Send Test</button>
                            <span id="telegram-test-result" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- Pushover -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Pushover</h3>
                                <p class="text-xs text-gray-500">Mobile push notifications</p>
                            </div>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="pushover-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="password" id="pushover-user-key" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="User Key">
                            <input type="password" id="pushover-api-token" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="API Token">
                        </div>
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="testNotification('pushover')" class="text-sm text-primary hover:text-yellow-400 font-medium">Send Test</button>
                            <span id="pushover-test-result" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <!-- Gotify -->
                <div class="bg-white/30 dark:bg-gray-800/30 rounded-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-teal-500 to-cyan-600 flex items-center justify-center shadow-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">Gotify</h3>
                                <p class="text-xs text-gray-500">Self-hosted notifications</p>
                            </div>
                        </div>
                        <label class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer">
                            <input type="checkbox" id="gotify-enabled">
                            <span class="pointer-events-none inline-block h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-700 transition-colors peer-checked:bg-primary"></span>
                        </label>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="gotify-server-url" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Server URL">
                            <input type="password" id="gotify-app-token" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="App Token">
                        </div>
                        <div class="mt-3 flex items-center gap-4">
                            <button onclick="testNotification('gotify')" class="text-sm text-primary hover:text-yellow-400 font-medium">Send Test</button>
                            <span id="gotify-test-result" class="text-sm"></span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button onclick="saveAllSettings()" class="save-btn flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-gray-900 text-sm font-semibold cursor-pointer transition-colors hover:bg-yellow-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 right-6 hidden z-50 animate-slide-up">
    <div class="flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl text-sm font-medium">
        <span id="toast-message"></span>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentConfig = {};

    const NAV_INACTIVE = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all';
    const NAV_ACTIVE = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-gray-900 dark:text-white bg-gray-200 dark:bg-gray-700 transition-all';

    function showSection(name) {
        document.querySelectorAll('.settings-section').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('[data-section]').forEach(el => el.className = NAV_INACTIVE);
        document.getElementById(`section-${name}`).classList.remove('hidden');
        document.querySelector(`[data-section="${name}"]`).className = NAV_ACTIVE;
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        toast.querySelector('div').className = `flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl text-sm font-medium ${isError ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
        document.getElementById('toast-message').textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // Listen for theme changes
    document.querySelectorAll('input[name="theme"]').forEach(input => {
        input.addEventListener('change', (e) => {
            window.applyTheme(e.target.value);
        });
    });

    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            currentConfig = await response.json();
            populateForm();
        } catch (e) {
            showToast('Failed to load configuration', true);
        }
    }

    function populateForm() {
        // General
        document.getElementById(`theme-${currentConfig.ui?.theme || 'dark'}`).checked = true;
        document.getElementById('timezone').value = currentConfig.ui?.timezone || 'America/New_York';

        // Plex
        document.getElementById('plex-enabled').checked = currentConfig.plex?.enabled ?? false;
        document.getElementById('plex-url').value = currentConfig.plex?.url ?? '';
        document.getElementById('plex-token').value = currentConfig.plex?.token ?? '';

        // Actions
        document.getElementById('actions-dry-run').checked = currentConfig.actions?.dry_run ?? false;
        document.getElementById('actions-auto-replace').checked = currentConfig.actions?.auto_replace ?? true;
        document.getElementById('actions-auto-delete-duplicates').checked = currentConfig.actions?.auto_delete_duplicates ?? false;
        document.getElementById('actions-blocklist').checked = currentConfig.actions?.blocklist_bad_releases ?? true;
        document.getElementById('actions-max-replacements').value = currentConfig.actions?.max_replacements_per_day ?? 10;

        // Scanner
        document.getElementById('scanner-enabled').checked = currentConfig.scanner?.enabled ?? true;
        document.getElementById('scanner-files-per-hour').value = currentConfig.scanner?.files_per_hour ?? 300;
        document.getElementById('scanner-files-per-hour-slider').value = currentConfig.scanner?.files_per_hour ?? 300;
        document.getElementById('scanner-mode').value = currentConfig.scanner?.mode ?? 'watch_only';
        document.getElementById('scanner-concurrency').value = currentConfig.scanner?.concurrency ?? 10;

        // Validation
        document.getElementById('validation-deep-scan').checked = currentConfig.validation?.deep_scan_enabled ?? true;
        document.getElementById('validation-deep-scan-mode').value = currentConfig.validation?.deep_scan_mode ?? 'partial';
        document.getElementById('validation-sample-duration').value = currentConfig.validation?.sample_duration_seconds ?? 10;
        document.getElementById('validation-decode-timeout').value = currentConfig.validation?.decode_timeout_seconds ?? 60;
        document.getElementById('validation-check-bitrate').checked = currentConfig.validation?.check_bitrate ?? true;
        document.getElementById('validation-replace-3d').checked = currentConfig.validation?.replace_3d ?? false;

        // Email
        document.getElementById('email-enabled').checked = currentConfig.email?.enabled ?? false;
        document.getElementById('email-smtp-host').value = currentConfig.email?.smtp_host ?? '';
        document.getElementById('email-smtp-port').value = currentConfig.email?.smtp_port ?? 587;
        document.getElementById('email-smtp-user').value = currentConfig.email?.smtp_user ?? '';
        document.getElementById('email-from').value = currentConfig.email?.from_address ?? '';
        document.getElementById('email-to').value = currentConfig.email?.to_address ?? '';

        // Notifications
        const notif = currentConfig.notifications || {};
        document.getElementById('discord-enabled').checked = notif.discord?.enabled ?? false;
        document.getElementById('discord-webhook').value = notif.discord?.webhook_url ?? '';
        document.getElementById('slack-enabled').checked = notif.slack?.enabled ?? false;
        document.getElementById('slack-webhook').value = notif.slack?.webhook_url ?? '';
        document.getElementById('telegram-enabled').checked = notif.telegram?.enabled ?? false;
        document.getElementById('telegram-bot-token').value = notif.telegram?.bot_token ?? '';
        document.getElementById('telegram-chat-id').value = notif.telegram?.chat_id ?? '';
        document.getElementById('pushover-enabled').checked = notif.pushover?.enabled ?? false;
        document.getElementById('pushover-user-key').value = notif.pushover?.user_key ?? '';
        document.getElementById('pushover-api-token').value = notif.pushover?.api_token ?? '';
        document.getElementById('gotify-enabled').checked = notif.gotify?.enabled ?? false;
        document.getElementById('gotify-server-url').value = notif.gotify?.server_url ?? '';
        document.getElementById('gotify-app-token').value = notif.gotify?.app_token ?? '';

        // Instances
        renderInstances('radarr', currentConfig.radarr || []);
        renderInstances('sonarr', currentConfig.sonarr || []);
    }

    function renderInstances(type, instances) {
        const container = document.getElementById(`${type}-instances`);
        if (instances.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 italic py-2">No instances configured</p>';
            return;
        }
        container.innerHTML = instances.map((inst, idx) => `
            <div class="p-4 bg-gray-100/30 dark:bg-gray-900/30 rounded-xl border border-gray-200/50 dark:border-gray-700/50" data-instance="${type}-${idx}">
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <input type="text" value="${inst.name}" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="Name" data-field="name">
                    <input type="text" value="${inst.url}" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="URL" data-field="url">
                    <input type="password" value="${inst.api_key}" class="w-full px-4 py-2.5 rounded-xl bg-gray-100/50 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-700 text-gray-900 dark:text-white text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:border-primary focus:ring-1 focus:ring-primary/50 transition-all" placeholder="API Key" data-field="api_key">
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="testConnection('${type}', ${idx})" class="text-sm text-primary hover:text-yellow-400 font-medium">Test</button>
                        <span id="status-${type}-${idx}" class="text-sm"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleAdvanced('${type}', ${idx})" class="text-xs text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Path Mappings</button>
                        <button onclick="removeInstance('${type}', ${idx})" class="text-xs text-red-400 hover:text-red-300">Remove</button>
                    </div>
                </div>
                <div id="advanced-${type}-${idx}" class="hidden mt-4 pt-4 border-t border-gray-200/50 dark:border-gray-700/50">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Path Mappings</span>
                        <button onclick="addPathMapping('${type}', ${idx})" class="text-xs text-primary hover:text-yellow-400">+ Add Mapping</button>
                    </div>
                    <div class="path-mappings space-y-2">
                        ${(inst.path_mappings || []).map((pm, pmIdx) => `
                            <div class="flex items-center gap-2">
                                <input type="text" value="${pm.from_path}" class="settings-input flex-1 text-xs" placeholder="${type === 'radarr' ? 'Radarr' : 'Sonarr'} path (e.g. /movies)" data-field="from_path" data-pm-idx="${pmIdx}">
                                <svg class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                                <input type="text" value="${pm.to_path}" class="settings-input flex-1 text-xs" placeholder="Janitor path (e.g. /media/movies)" data-field="to_path" data-pm-idx="${pmIdx}">
                                <button onclick="removePathMapping('${type}', ${idx}, ${pmIdx})" class="text-gray-500 hover:text-red-400 p-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-600 mt-3">Translate paths between ${type === 'radarr' ? 'Radarr' : 'Sonarr'} and Media Janitor containers</p>
                </div>
            </div>
        `).join('');
    }

    function toggleAdvanced(type, idx) {
        document.getElementById(`advanced-${type}-${idx}`).classList.toggle('hidden');
    }

    function addInstance(type) {
        if (!currentConfig[type]) currentConfig[type] = [];
        currentConfig[type].push({ name: `${type}-${currentConfig[type].length + 1}`, url: '', api_key: '', path_mappings: [] });
        renderInstances(type, currentConfig[type]);
    }

    function removeInstance(type, idx) {
        currentConfig[type].splice(idx, 1);
        renderInstances(type, currentConfig[type]);
    }

    function addPathMapping(type, instIdx) {
        // Sync current input values to currentConfig before adding new mapping
        const advDiv = document.getElementById(`advanced-${type}-${instIdx}`);
        if (advDiv) {
            currentConfig[type][instIdx].path_mappings = [];
            advDiv.querySelectorAll('.path-mappings > div').forEach(pmDiv => {
                const fromPath = pmDiv.querySelector('[data-field="from_path"]');
                const toPath = pmDiv.querySelector('[data-field="to_path"]');
                if (fromPath && toPath) {
                    currentConfig[type][instIdx].path_mappings.push({ from_path: fromPath.value, to_path: toPath.value });
                }
            });
        }
        if (!currentConfig[type][instIdx].path_mappings) currentConfig[type][instIdx].path_mappings = [];
        currentConfig[type][instIdx].path_mappings.push({ from_path: '', to_path: '' });
        renderInstances(type, currentConfig[type]);
        document.getElementById(`advanced-${type}-${instIdx}`).classList.remove('hidden');
    }

    function removePathMapping(type, instIdx, pmIdx) {
        // Sync current input values to currentConfig before removing
        const advDiv = document.getElementById(`advanced-${type}-${instIdx}`);
        if (advDiv) {
            currentConfig[type][instIdx].path_mappings = [];
            advDiv.querySelectorAll('.path-mappings > div').forEach(pmDiv => {
                const fromPath = pmDiv.querySelector('[data-field="from_path"]');
                const toPath = pmDiv.querySelector('[data-field="to_path"]');
                if (fromPath && toPath) {
                    currentConfig[type][instIdx].path_mappings.push({ from_path: fromPath.value, to_path: toPath.value });
                }
            });
        }
        currentConfig[type][instIdx].path_mappings.splice(pmIdx, 1);
        renderInstances(type, currentConfig[type]);
        document.getElementById(`advanced-${type}-${instIdx}`).classList.remove('hidden');
    }

    async function testConnection(type, idx) {
        const container = document.querySelector(`[data-instance="${type}-${idx}"]`);
        const status = document.getElementById(`status-${type}-${idx}`);
        const url = container.querySelector('[data-field="url"]').value;
        const api_key = container.querySelector('[data-field="api_key"]').value;

        status.innerHTML = '<span class="text-gray-400">Testing...</span>';

        try {
            const response = await fetch('/api/test-connection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, url, api_key })
            });
            const data = await response.json();
            status.innerHTML = data.success
                ? `<span class="text-green-400">Connected (v${data.version})</span>`
                : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            status.innerHTML = '<span class="text-red-400">Connection failed</span>';
        }
    }

    async function testPlex() {
        const status = document.getElementById('plex-status');
        status.innerHTML = '<span class="text-gray-400">Testing...</span>';
        try {
            const response = await fetch('/api/test-plex', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: document.getElementById('plex-url').value,
                    token: document.getElementById('plex-token').value
                })
            });
            const data = await response.json();
            status.innerHTML = data.success
                ? '<span class="text-green-400">Connected</span>'
                : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            status.innerHTML = '<span class="text-red-400">Connection failed</span>';
        }
    }

    async function testNotification(service) {
        const result = document.getElementById(`${service}-test-result`);
        result.innerHTML = '<span class="text-gray-400">Sending...</span>';

        const payload = { service };
        if (service === 'discord') payload.webhook_url = document.getElementById('discord-webhook').value;
        else if (service === 'slack') payload.webhook_url = document.getElementById('slack-webhook').value;
        else if (service === 'telegram') {
            payload.bot_token = document.getElementById('telegram-bot-token').value;
            payload.chat_id = document.getElementById('telegram-chat-id').value;
        } else if (service === 'pushover') {
            payload.user_key = document.getElementById('pushover-user-key').value;
            payload.api_token = document.getElementById('pushover-api-token').value;
        } else if (service === 'gotify') {
            payload.server_url = document.getElementById('gotify-server-url').value;
            payload.app_token = document.getElementById('gotify-app-token').value;
        }

        try {
            const response = await fetch('/api/test-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            result.innerHTML = data.success
                ? '<span class="text-green-400">Sent!</span>'
                : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            result.innerHTML = '<span class="text-red-400">Failed</span>';
        }
    }

    async function testEmail() {
        const result = document.getElementById('email-test-result');
        result.innerHTML = '<span class="text-gray-400">Sending...</span>';
        try {
            const response = await fetch('/api/test-email', { method: 'POST' });
            const data = await response.json();
            result.innerHTML = data.success
                ? '<span class="text-green-400">Sent!</span>'
                : `<span class="text-red-400">${data.error}</span>`;
        } catch (e) {
            result.innerHTML = '<span class="text-red-400">Failed</span>';
        }
    }

    function setupGmail() {
        document.getElementById('email-smtp-host').value = 'smtp.gmail.com';
        document.getElementById('email-smtp-port').value = '587';
    }

    function setupOutlook() {
        document.getElementById('email-smtp-host').value = 'smtp.office365.com';
        document.getElementById('email-smtp-port').value = '587';
    }

    function collectFormData() {
        ['radarr', 'sonarr'].forEach(type => {
            const containers = document.querySelectorAll(`[data-instance^="${type}-"]`);
            currentConfig[type] = [];
            containers.forEach((container, idx) => {
                const inst = {
                    name: container.querySelector('[data-field="name"]').value,
                    url: container.querySelector('[data-field="url"]').value,
                    api_key: container.querySelector('[data-field="api_key"]').value,
                    path_mappings: []
                };
                const advDiv = document.getElementById(`advanced-${type}-${idx}`);
                if (advDiv) {
                    advDiv.querySelectorAll('.path-mappings > div').forEach(pmDiv => {
                        const fromPath = pmDiv.querySelector('[data-field="from_path"]');
                        const toPath = pmDiv.querySelector('[data-field="to_path"]');
                        if (fromPath && toPath && (fromPath.value || toPath.value)) {
                            inst.path_mappings.push({ from_path: fromPath.value, to_path: toPath.value });
                        }
                    });
                }
                currentConfig[type].push(inst);
            });
        });

        currentConfig.ui = {
            theme: document.querySelector('input[name="theme"]:checked')?.value || 'dark',
            timezone: document.getElementById('timezone').value
        };

        currentConfig.plex = {
            enabled: document.getElementById('plex-enabled').checked,
            url: document.getElementById('plex-url').value,
            token: document.getElementById('plex-token').value,
            refresh_on_replace: true
        };

        currentConfig.actions = {
            ...currentConfig.actions,
            dry_run: document.getElementById('actions-dry-run').checked,
            auto_replace: document.getElementById('actions-auto-replace').checked,
            auto_delete_duplicates: document.getElementById('actions-auto-delete-duplicates').checked,
            blocklist_bad_releases: document.getElementById('actions-blocklist').checked,
            max_replacements_per_day: parseInt(document.getElementById('actions-max-replacements').value)
        };

        currentConfig.scanner = {
            ...currentConfig.scanner,
            enabled: document.getElementById('scanner-enabled').checked,
            files_per_hour: parseInt(document.getElementById('scanner-files-per-hour').value),
            mode: document.getElementById('scanner-mode').value,
            concurrency: parseInt(document.getElementById('scanner-concurrency').value) || 10
        };

        currentConfig.validation = {
            ...currentConfig.validation,
            deep_scan_enabled: document.getElementById('validation-deep-scan').checked,
            deep_scan_mode: document.getElementById('validation-deep-scan-mode').value,
            sample_duration_seconds: parseInt(document.getElementById('validation-sample-duration').value) || 10,
            decode_timeout_seconds: parseInt(document.getElementById('validation-decode-timeout').value) || 60,
            check_bitrate: document.getElementById('validation-check-bitrate').checked,
            replace_3d: document.getElementById('validation-replace-3d').checked
        };

        currentConfig.email = {
            ...currentConfig.email,
            enabled: document.getElementById('email-enabled').checked,
            smtp_host: document.getElementById('email-smtp-host').value,
            smtp_port: parseInt(document.getElementById('email-smtp-port').value) || 587,
            smtp_user: document.getElementById('email-smtp-user').value,
            smtp_password: document.getElementById('email-smtp-password').value || currentConfig.email?.smtp_password,
            from_address: document.getElementById('email-from').value,
            to_address: document.getElementById('email-to').value
        };

        currentConfig.notifications = {
            discord: { enabled: document.getElementById('discord-enabled').checked, webhook_url: document.getElementById('discord-webhook').value },
            slack: { enabled: document.getElementById('slack-enabled').checked, webhook_url: document.getElementById('slack-webhook').value },
            telegram: { enabled: document.getElementById('telegram-enabled').checked, bot_token: document.getElementById('telegram-bot-token').value, chat_id: document.getElementById('telegram-chat-id').value },
            pushover: { enabled: document.getElementById('pushover-enabled').checked, user_key: document.getElementById('pushover-user-key').value, api_token: document.getElementById('pushover-api-token').value },
            gotify: { enabled: document.getElementById('gotify-enabled').checked, server_url: document.getElementById('gotify-server-url').value, app_token: document.getElementById('gotify-app-token').value }
        };

        return currentConfig;
    }

    async function saveAllSettings() {
        // Disable all save buttons and show loading state
        const saveButtons = document.querySelectorAll('.save-btn');
        saveButtons.forEach(btn => {
            btn.disabled = true;
            btn.dataset.originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Saving...';
        });

        try {
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(collectFormData())
            });
            showToast(response.ok ? 'Settings saved successfully!' : 'Failed to save settings', !response.ok);
        } catch (e) {
            showToast('Failed to save settings', true);
        } finally {
            // Restore save buttons
            saveButtons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText;
            });
        }
    }

    loadConfig();
</script>
{% endblock %}
