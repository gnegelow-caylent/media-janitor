{% extends "base.html" %}

{% block title %}Reports - Media Janitor{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="md:flex md:items-center md:justify-between">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Reports</h2>
    </div>

    <!-- Report Cards Grid -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">

        <!-- Path Mismatches -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('mismatches')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Path Mismatches</h3>
                <span class="text-2xl">üìÅ</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Files in wrong folders or with wrong names</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- Suspiciously Small -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('small')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Suspiciously Small</h3>
                <span class="text-2xl">‚ö†Ô∏è</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Files that may be corrupt or incomplete</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- Duplicates -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('duplicates')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Duplicates</h3>
                <span class="text-2xl">üëØ</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Same content in multiple qualities</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- Upgrade Opportunities -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('upgrades')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Upgrade Opportunities</h3>
                <span class="text-2xl">‚¨ÜÔ∏è</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Watched content that could be upgraded</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Requires Plex ‚Üí</span>
            </div>
        </div>

        <!-- Codec Report -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('codecs')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Codec Breakdown</h3>
                <span class="text-2xl">üé¨</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">H.264, HEVC, AV1 distribution</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- HDR Report -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('hdr')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">HDR Content</h3>
                <span class="text-2xl">üåà</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">HDR10, Dolby Vision, HDR10+</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- Replaced Files -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('replaced')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Replaced Files</h3>
                <span class="text-2xl">üîÑ</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Files that were auto-replaced</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- Missing Files -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('missing')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Missing Files</h3>
                <span class="text-2xl">‚ùì</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">In Radarr/Sonarr but not on disk</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Click to run report ‚Üí</span>
            </div>
        </div>

        <!-- Orphan Files (Plex) -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('orphans')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Orphan Files</h3>
                <span class="text-2xl">üëª</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">In Plex but not Radarr/Sonarr (or vice versa)</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Requires Plex ‚Üí</span>
            </div>
        </div>

        <!-- Playback Issues (Plex) -->
        <div class="stat-card hover:border-primary transition-colors cursor-pointer" onclick="loadReport('playback')">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Playback Issues</h3>
                <span class="text-2xl">‚è∏Ô∏è</span>
            </div>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Files users started but didn't finish</p>
            <div class="mt-4">
                <span class="text-primary text-sm">Requires Plex ‚Üí</span>
            </div>
        </div>

    </div>

    <!-- Report Results Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden">
                <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white" id="modal-title">Report</h3>
                    <button onclick="closeModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-2xl">&times;</button>
                </div>
                <div class="p-4 overflow-y-auto max-h-[60vh]" id="modal-content">
                    <!-- Report content loaded here -->
                </div>
                <div class="flex justify-end p-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            <p class="mt-4 text-gray-900 dark:text-white">Generating report...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('report-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('report-modal').classList.add('hidden');
    }

    async function loadReport(type) {
        showLoading();

        try {
            switch (type) {
                case 'mismatches':
                    await loadMismatchReport();
                    break;
                case 'small':
                    await loadSmallFilesReport();
                    break;
                case 'duplicates':
                    await loadDuplicatesReport();
                    break;
                case 'upgrades':
                    await loadUpgradesReport();
                    break;
                case 'replaced':
                    await loadReplacedReport();
                    break;
                case 'missing':
                    await loadMissingReport();
                    break;
                case 'orphans':
                    await loadOrphansReport();
                    break;
                case 'playback':
                    await loadPlaybackReport();
                    break;
                case 'codecs':
                    await loadCodecsReport();
                    break;
                case 'hdr':
                    await loadHdrReport();
                    break;
            }
        } catch (e) {
            showModal('Error', `<p class="text-red-400">Failed to load report: ${escapeHtml(e.message)}</p>`);
        } finally {
            hideLoading();
        }
    }

    async function loadMismatchReport() {
        const response = await fetch('/report/mismatches?source=movies');
        const data = await response.json();

        let content = '';

        if (data.count === 0) {
            content = '<p class="text-green-400">No path mismatches found!</p>';
        } else {
            content = `
                <p class="text-yellow-400 mb-4">Found ${data.count} potential mismatches</p>
                <div class="space-y-4">
            `;

            data.mismatches.forEach(m => {
                content += `
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-900 dark:text-white font-medium">${escapeHtml(m.title)} (${escapeHtml(m.year) || 'Unknown year'})</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Expected: ${escapeHtml(m.expected_folder)}</p>
                                <p class="text-sm text-red-400 mt-1">Actual: ${escapeHtml(m.actual_filename)}</p>
                            </div>
                            <span class="text-xs bg-yellow-600 text-white px-2 py-1 rounded">${escapeHtml(m.mismatch_type)}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 truncate">${escapeHtml(m.file_path)}</p>
                    </div>
                `;
            });

            content += '</div>';
        }

        showModal('Path Mismatches', content);
    }

    async function loadSmallFilesReport() {
        const response = await fetch('/report/library?source=movies');
        const data = await response.json();

        // Filter for suspiciously small files (< 500MB for movies)
        const smallFiles = (data.smallest_files || []).filter(f => f.size_bytes < 500000000);

        let content = '';

        if (smallFiles.length === 0) {
            content = '<p class="text-green-400">No suspiciously small files found!</p>';
        } else {
            content = `
                <p class="text-yellow-400 mb-4">Found ${smallFiles.length} suspiciously small files</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left text-xs text-gray-600 dark:text-gray-400">Title</th>
                                <th class="px-4 py-2 text-left text-xs text-gray-600 dark:text-gray-400">Size</th>
                                <th class="px-4 py-2 text-left text-xs text-gray-600 dark:text-gray-400">Quality</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            smallFiles.forEach(f => {
                const sizeClass = f.size_bytes < 100000000 ? 'text-red-400' : 'text-yellow-400';
                content += `
                    <tr>
                        <td class="px-4 py-2 text-sm text-gray-900 dark:text-white">${escapeHtml(f.title)}</td>
                        <td class="px-4 py-2 text-sm ${sizeClass} font-mono">${escapeHtml(f.size_human)}</td>
                        <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">${escapeHtml(f.quality) || '-'}</td>
                    </tr>
                `;
            });

            content += '</tbody></table></div>';
        }

        showModal('Suspiciously Small Files', content);
    }

    async function loadDuplicatesReport() {
        const response = await fetch('/report/duplicates?source=movies');
        const data = await response.json();

        let content = '';

        if (data.count === 0) {
            content = '<p class="text-green-400">No duplicate content found!</p>';
        } else {
            content = `
                <div class="mb-4">
                    <p class="text-yellow-400">Found ${data.count} items with multiple copies</p>
                    <p class="text-gray-600 dark:text-gray-400 text-sm">Potential space savings: <span class="text-green-400 font-bold">${escapeHtml(data.total_potential_savings_human)}</span></p>
                </div>
                <div class="space-y-4">
            `;

            data.duplicates.slice(0, 20).forEach(d => {
                content += `
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-gray-900 dark:text-white font-medium">${escapeHtml(d.title)} (${escapeHtml(d.year) || 'Unknown year'})</p>
                            <span class="text-xs bg-green-600 text-white px-2 py-1 rounded">Save ${escapeHtml(d.potential_savings_human)}</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${d.copies} copies, total ${escapeHtml(d.total_size_human)}</p>
                        <div class="space-y-1">
                `;

                d.files.forEach((f, i) => {
                    const bgClass = i === 0 ? 'bg-gray-200 dark:bg-gray-600' : 'bg-gray-50 dark:bg-gray-800';
                    const label = i === 0 ? '<span class="text-xs text-green-400 ml-2">(keep)</span>' : '<span class="text-xs text-red-400 ml-2">(remove)</span>';
                    content += `
                        <div class="${bgClass} rounded p-2 text-sm">
                            <span class="text-gray-700 dark:text-gray-300">${escapeHtml(f.quality) || 'Unknown'}</span>
                            <span class="text-gray-500 ml-2">${escapeHtml(f.size_human)}</span>
                            ${label}
                        </div>
                    `;
                });

                content += `
                        </div>
                    </div>
                `;
            });

            if (data.count > 20) {
                content += `<p class="text-gray-600 dark:text-gray-400 text-sm mt-4">Showing top 20 of ${data.count} duplicates</p>`;
            }

            content += '</div>';
        }

        showModal('Duplicate Content', content);
    }

    async function loadCodecsReport() {
        const response = await fetch('/report/codecs?source=movies');
        const data = await response.json();

        let content = `
            <p class="text-gray-600 dark:text-gray-400 mb-4">Total files analyzed: ${data.total_files}</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        `;

        // Video codecs
        content += `
            <div>
                <h4 class="text-gray-900 dark:text-white font-medium mb-3">Video Codecs</h4>
                <div class="space-y-2">
        `;
        const sortedCodecs = Object.entries(data.video_codecs || {}).sort((a, b) => b[1] - a[1]);
        sortedCodecs.forEach(([codec, count]) => {
            const pct = ((count / data.total_files) * 100).toFixed(1);
            const colorClass = codec.includes('HEVC') ? 'bg-green-600' : codec.includes('AV1') ? 'bg-blue-600' : 'bg-gray-600';
            content += `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-700 dark:text-gray-300">${escapeHtml(codec)}</span>
                        <span class="text-gray-600 dark:text-gray-400">${count} (${pct}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="${colorClass} h-2 rounded-full" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        });
        content += '</div></div>';

        // Containers
        content += `
            <div>
                <h4 class="text-gray-900 dark:text-white font-medium mb-3">Containers</h4>
                <div class="space-y-2">
        `;
        const sortedContainers = Object.entries(data.containers || {}).sort((a, b) => b[1] - a[1]);
        sortedContainers.forEach(([container, count]) => {
            const pct = ((count / data.total_files) * 100).toFixed(1);
            content += `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-700 dark:text-gray-300">.${escapeHtml(container)}</span>
                        <span class="text-gray-600 dark:text-gray-400">${count} (${pct}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        });
        content += '</div></div>';

        content += '</div>';
        showModal('Codec Breakdown', content);
    }

    async function loadHdrReport() {
        const response = await fetch('/report/codecs?source=movies');
        const data = await response.json();

        let content = `
            <p class="text-gray-600 dark:text-gray-400 mb-4">Total files analyzed: ${data.total_files}</p>
            <div class="space-y-4">
                <h4 class="text-gray-900 dark:text-white font-medium">HDR Types</h4>
        `;

        const sortedHdr = Object.entries(data.hdr_types || {}).sort((a, b) => b[1] - a[1]);
        sortedHdr.forEach(([hdr, count]) => {
            const pct = ((count / data.total_files) * 100).toFixed(1);
            let colorClass = 'bg-gray-600';
            if (hdr === 'Dolby Vision') colorClass = 'bg-purple-600';
            else if (hdr === 'HDR10+') colorClass = 'bg-blue-600';
            else if (hdr === 'HDR10') colorClass = 'bg-green-600';
            else if (hdr === 'SDR') colorClass = 'bg-gray-500';

            content += `
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-700 dark:text-gray-300">${escapeHtml(hdr)}</span>
                        <span class="text-gray-600 dark:text-gray-400">${count} (${pct}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div class="${colorClass} h-3 rounded-full" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        });

        content += '</div>';
        showModal('HDR Content', content);
    }

    async function loadReplacedReport() {
        const response = await fetch('/report/replaced');
        const data = await response.json();

        let content = '';

        if (data.count === 0) {
            content = '<p class="text-green-400">No files have been replaced yet.</p>';
        } else {
            content = `
                <p class="text-gray-600 dark:text-gray-400 mb-4">Total files replaced: ${data.count}</p>
                <div class="space-y-3">
            `;

            data.replaced.forEach(r => {
                const wrongFileTag = r.wrong_file ? '<span class="text-xs bg-red-600 text-white px-2 py-1 rounded ml-2">Wrong File</span>' : '';
                const typeTag = r.media_type === 'movie' ? '<span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">Movie</span>' : '<span class="text-xs bg-purple-600 text-white px-2 py-1 rounded">TV</span>';
                content += `
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-900 dark:text-white font-medium">${escapeHtml(r.title) || 'Unknown'}</p>
                                <p class="text-sm text-red-400 mt-1">${escapeHtml(r.reason) || 'Unknown reason'}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${typeTag}${wrongFileTag}
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 truncate">${escapeHtml(r.path)}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-600 mt-1">${new Date(r.timestamp).toLocaleString()}</p>
                    </div>
                `;
            });

            content += '</div>';
        }

        showModal('Replaced Files', content);
    }

    async function loadMissingReport() {
        const response = await fetch('/report/missing');
        const data = await response.json();

        let content = '';

        if (data.count === 0) {
            content = '<p class="text-green-400">No missing files found! All files in Radarr/Sonarr exist on disk.</p>';
        } else {
            content = `
                <div class="mb-4">
                    <p class="text-yellow-400">Found ${data.count} missing files</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Movies: ${data.movies_count} | TV Episodes: ${data.tv_count}</p>
                    <p class="text-sm text-gray-500 mt-2">These files exist in Radarr/Sonarr but not on disk. Consider removing them from your arr apps or re-downloading.</p>
                </div>
                <div class="flex justify-end mb-4">
                    <button onclick="clearMissingReport()" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-500">
                        Clear Report
                    </button>
                </div>
            `;

            if (data.movies && data.movies.length > 0) {
                content += `
                    <div class="mb-6">
                        <h4 class="text-gray-900 dark:text-white font-medium mb-3">Movies (${data.movies_count})</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                `;
                data.movies.forEach(m => {
                    const filename = m.path.split('/').pop();
                    content += `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded p-2">
                            <p class="text-sm text-gray-900 dark:text-white truncate">${escapeHtml(filename)}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(m.path)}</p>
                        </div>
                    `;
                });
                content += '</div></div>';
            }

            if (data.tv && data.tv.length > 0) {
                content += `
                    <div>
                        <h4 class="text-gray-900 dark:text-white font-medium mb-3">TV Episodes (${data.tv_count})</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                `;
                data.tv.forEach(m => {
                    const filename = m.path.split('/').pop();
                    content += `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded p-2">
                            <p class="text-sm text-gray-900 dark:text-white truncate">${escapeHtml(filename)}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(m.path)}</p>
                        </div>
                    `;
                });
                content += '</div></div>';
            }
        }

        showModal('Missing Files', content);
    }

    async function clearMissingReport() {
        if (!confirm('Clear the missing files report? This will reset the list.')) return;

        const response = await fetch('/report/missing/clear', { method: 'POST' });
        if (response.ok) {
            loadMissingReport(); // Reload the report
        }
    }

    async function loadUpgradesReport() {
        const response = await fetch('/report/upgrades');

        if (!response.ok) {
            const error = await response.json();
            showModal('Upgrade Opportunities', `<p class="text-yellow-400">${escapeHtml(error.detail) || 'Plex integration required. Configure Plex in Settings.'}</p>`);
            return;
        }

        const data = await response.json();

        let content = '';

        if (data.count === 0) {
            content = '<p class="text-green-400">No upgrade opportunities found! Your watched content is already high quality.</p>';
        } else {
            content = `
                <p class="text-gray-600 dark:text-gray-400 mb-4">Found ${data.count} items that could be upgraded</p>
                <div class="space-y-3">
            `;

            data.upgrades.forEach(u => {
                content += `
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-900 dark:text-white font-medium">${escapeHtml(u.title)}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Current: <span class="text-yellow-400">${escapeHtml(u.current_quality)}</span></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Suggested: <span class="text-green-400">${escapeHtml(u.suggested_quality)}</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">${u.view_count} views</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            content += '</div>';
        }

        showModal('Upgrade Opportunities', content);
    }

    async function loadOrphansReport() {
        const response = await fetch('/report/orphans');

        if (!response.ok) {
            const error = await response.json();
            showModal('Orphan Files', `<p class="text-yellow-400">${escapeHtml(error.detail) || 'Plex integration required. Configure Plex in Settings.'}</p>`);
            return;
        }

        const data = await response.json();

        let content = '';
        const totalOrphans = data.plex_only.length + data.arr_only.length;

        if (totalOrphans === 0) {
            content = '<p class="text-green-400">No orphan files found! Libraries are in sync.</p>';
        } else {
            content = '<div class="space-y-6">';

            if (data.plex_only.length > 0) {
                content += `
                    <div>
                        <h4 class="text-gray-900 dark:text-white font-medium mb-3">In Plex Only (${data.plex_only.length})</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">These files are in Plex but not tracked by Radarr/Sonarr</p>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                `;
                data.plex_only.slice(0, 20).forEach(p => {
                    content += `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded p-2">
                            <p class="text-sm text-gray-900 dark:text-white">${escapeHtml(p.title)}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(p.file_path) || 'Unknown path'}</p>
                        </div>
                    `;
                });
                if (data.plex_only.length > 20) {
                    content += `<p class="text-xs text-gray-500">...and ${data.plex_only.length - 20} more</p>`;
                }
                content += '</div></div>';
            }

            if (data.arr_only.length > 0) {
                content += `
                    <div>
                        <h4 class="text-gray-900 dark:text-white font-medium mb-3">In Radarr/Sonarr Only (${data.arr_only.length})</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">These files are tracked but not in Plex</p>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                `;
                data.arr_only.slice(0, 20).forEach(a => {
                    content += `
                        <div class="bg-gray-100 dark:bg-gray-700 rounded p-2">
                            <p class="text-sm text-gray-900 dark:text-white">${escapeHtml(a.title)}</p>
                            <p class="text-xs text-gray-500 truncate">${escapeHtml(a.file_path) || 'Unknown path'}</p>
                        </div>
                    `;
                });
                if (data.arr_only.length > 20) {
                    content += `<p class="text-xs text-gray-500">...and ${data.arr_only.length - 20} more</p>`;
                }
                content += '</div></div>';
            }

            content += '</div>';
        }

        showModal('Orphan Files', content);
    }

    async function loadPlaybackReport() {
        const response = await fetch('/report/playback-issues');

        if (!response.ok) {
            const error = await response.json();
            showModal('Playback Issues', `<p class="text-yellow-400">${escapeHtml(error.detail) || 'Plex integration required. Configure Plex in Settings.'}</p>`);
            return;
        }

        const data = await response.json();

        let content = '';

        if (data.count === 0) {
            content = '<p class="text-green-400">No playback issues detected!</p>';
        } else {
            content = `
                <p class="text-gray-600 dark:text-gray-400 mb-4">Found ${data.count} potential playback issues</p>
                <p class="text-sm text-gray-500 mb-4">These are files that users started watching but didn't finish - may indicate playback problems</p>
                <div class="space-y-3">
            `;

            data.issues.forEach(i => {
                const progressPct = Math.round(i.progress * 100);
                content += `
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-gray-900 dark:text-white font-medium">${escapeHtml(i.title)}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Stopped at ${progressPct}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">${escapeHtml(i.user) || 'Unknown user'}</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2 mt-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: ${progressPct}%"></div>
                        </div>
                    </div>
                `;
            });

            content += '</div>';
        }

        showModal('Playback Issues', content);
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
</script>
{% endblock %}
